<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/gamestyle.css">
    <title>Grille 5x5</title>
    <style>
        table {
            border-collapse: collapse;
        }

        td {
            width: 50px;
            height: 50px;
            border: 1px solid black;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
        }

        .player1 {
            background-color: blue;
        }

        .player2 {
            background-color: red;
        }

        .occupied {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2 id="turnMessage">C'est au tour de Joueur 1 de jouer !</h2>

    <table id="gameGrid">
        <tbody>
            <!-- Grid will be generated by JavaScript -->
        </tbody>
    </table>

    <script>
        // Initialize game state
        let gameState = {
            players: {
                player1: { id: 1, position: { x: 0, y: 0 }, name: "Player 1" },
                player2: { id: 2, position: { x: 4, y: 4 }, name: "Player 2" },
            },
            currentPlayer: 1,
        };

        

        // Function to generate the grid
        function generateGrid() {
    const grid = document.getElementById('gameGrid').getElementsByTagName('tbody')[0];
    
    // Clear existing grid if necessary
    grid.innerHTML = '';

    for (let i = 0; i < 5; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 5; j++) {
            const cell = document.createElement('td');
            cell.id = `cell-${i}-${j}`;
            cell.onclick = () => fetchValidMove(i+1, j+1); // Click handler for each cell
            row.appendChild(cell);
        }
        grid.appendChild(row);
    }
}
async function fetchAndPaintBoard() {
    try {
        const response = await fetch("http://127.0.0.1:5000/gameboard");
        if (!response.ok) {
            throw new Error("Network response was not OK");
        }

        const data = await response.json();
        if (data.board) {
            const boardArray = data.board.split(' '); // Adjust based on how your board is structured
            const grid = document.getElementById('gameGrid').getElementsByTagName('tbody')[0];

            // Clear the existing board before painting
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    const cell = grid.querySelector(`#cell-${i}-${j}`);
                    const cellValue = boardArray[i][j];

                    // Set cell color based on the value
                    if (cellValue === '1') {
                        cell.style.backgroundColor = 'blue'; // Player 1
                        cell.innerText = 'J1';
                    } else if (cellValue === '2') {
                        cell.style.backgroundColor = 'red'; // Player 2
                        cell.innerText = 'J2';
                    } else {
                        cell.style.backgroundColor = 'white'; // Empty cell
                        cell.innerText = '';
                    }
                }
            }
        } else {
            console.error("No board data in response:", data);
        }
    } catch (error) {
        console.error("Error fetching board:", error);
    }
}

        // Function to start the game
        async function startGame() {
            try {
                const response = await fetch("http://127.0.0.1:5000/start_game", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error("Network response was not OK");
                }

                const data = await response.json();
                console.log("Game started:", data);

                if (data.status === "success") {
                    // Initialize game state with the server response
                    initializeGameState(data.gameState);
                } else {
                    console.error("Failed to start the game:", data);
                }
            } catch (error) {
                console.error("Error starting game:", error);
            }
        }

        // Function to initialize the game state based on the received data
        function initializeGameState(gameStateData) {
            // Update player positions and game state based on server data
            gameState.players.player1.position = gameStateData.posPlayer1;
            gameState.players.player2.position = gameStateData.posPlayer2;
            gameState.currentPlayer = gameStateData.currentPlayer;
            fetchAndPaintBoard()

            // Log the updated state
            console.log("Updated game state:", gameState);
        }

        // Ensure the board is generated before calling startGame
        window.onload = function() {
            generateGrid();  // Generate the grid first
            startGame();
            fetchAndPaintBoard()     // Then call startGame to initialize the game
        };

        // Function to fetch the game board (if needed)
        async function fetchBoard() {
            try {
                const response = await fetch("http://127.0.0.1:5000/gameboard");
                if (!response.ok) {
                    throw new Error("Network response was not OK");
                }

                const boardString = await response.text();  // Use .text() for non-JSON responses
                console.log("Board:", boardString);
                return boardString;
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }
        async function fetchValidMove(i, j) {
    try {
        const response = await fetch("http://127.0.0.1:5000/validate_move", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ i: i, j: j })
        });

        if (!response.ok) {
            throw new Error("Network response was not OK");
        }

        const data = await response.json();
        console.log("Valid move response:", data);
        fetchAndPaintBoard()
        return data;
    } catch (error) {
        console.error("Error fetching valid move:", error);
    }
}
    </script>
</body>
</html>
