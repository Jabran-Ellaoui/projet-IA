<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/gamestyle.css">
    <title>Grille 5x5</title>
    <style>
        table {
            border-collapse: collapse;
        }

        td {
            width: 50px;
            height: 50px;
            border: 1px solid black;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
        }

        .player1 {
            background-color: blue;
        }

        .player2 {
            background-color: red;
        }

        .occupied {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2 id="turnMessage">C'est au tour de Joueur 1 de jouer !</h2>

    <table id="gameGrid">
        <tbody>
            <!-- Grid will be generated by JavaScript -->
        </tbody>
    </table>

    <script>
<<<<<<< HEAD
        let currentPlayer = 1;
        let game_id = {{ game_id }};  // Vous devez définir l'ID du jeu ici.
        let grille = {{ grid_state | tojson | safe}}
        let winner = {{ winner | default(0)}}

        function updateTurnMessage(winner) {
            const messageElement = document.getElementById("turnMessage");
            if (winner === 0) {
                messageElement.innerText = "Le jeu continue...";
                messageElement.style.color = "white";
            } else if (winner === 1) {
                messageElement.innerText = "Tu as gagné !!!";
                messageElement.style.color = "green";
            } else if (winner === 2) {
                messageElement.innerText = "L'IA a gagné !!!";
                messageElement.style.color = "red";
            } else {
                messageElement.innerText = "L'égalité ...";
                messageElement.style.color = "yellow";
            }
        }

        function generateGrid(gridString, current_player_x,current_player_y, other_player_x, other_player_y) {
            const gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';  // Effacer la grille actuelle

            const rows = gridString.trim().split(' '); // Diviser le string par lignes
            console.log("   !!! une tour est passé !!! ")
            for (let i = 0; i < rows.length; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < rows[i].length; j++) {
                    const cell = document.createElement('td');
                    cell.id = `cell-${i}-${j}`;

                    // Définir le contenu et les classes en fonction de la valeur
                    if (rows[i][j] == '1') {
                        cell.classList.add('player1', 'occupied');
                        cell.innerText = '';

                    } else if (rows[i][j] == '2') {
                        cell.classList.add('player2', 'occupied');
                        cell.innerText = '';
                    } 
                     
                    if (i == [current_player_y] && j == [current_player_x]) {
                        cell.innerText = 'X';
                        cell.style.color = 'black';
                        cell.style.fontWeight = 'bold';
                        cell.style.fontSize = '24px'; 
                        
                        console.log("Current player x : ", current_player_x, "Current player y : ",current_player_y)
                    }

                    if (i == [other_player_y] && j == [other_player_x]) {
                        cell.innerText = 'X';
                        cell.style.color = 'black';
                        console.log("Waiting player x : ", other_player_x, "Waiting player y : ", other_player_y)
                    }

                    row.appendChild(cell);
                }
                gridElement.appendChild(row);
            }
            
        }

        // Événement pour détecter les flèches directionnelles et envoyer le mouvement
        document.addEventListener('keydown', async function (event) {
            let x = 0, y = 0;
            switch (event.key) {
                case 'ArrowUp': y = -1; break;
                case 'ArrowDown': y = 1; break;
                case 'ArrowLeft': x = -1; break;
                case 'ArrowRight': x = 1; break;
                default: return;  // Ignore les autres touches
            }

            // Envoyer la demande au serveur
            const response = await fetch("http://127.0.0.1:5000/travel_request", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "current_x": x, "current_y": y, "game_id": game_id })
            }
            );

            const result = await response.json();
            if (result != "-1") 
            {
                generateGrid(result.new_grid,result.new_current_player_x,result.new_current_player_y, result.other_x, result.other_y);  // Met à jour la grille avec la nouvelle position
                updateTurnMessage(result.winner)
            }
        });

        // Initialiser la grille
        document.addEventListener("DOMContentLoaded", function () {
            // Remplir la grille initiale (fournie depuis le serveur ou définie ici)
            generateGrid(grille, 0,0,4,4) //todo : hardcodé, aaahhhh
        });
       
=======
        // Initialize game state
        let gameState = {
            players: {
                player1: { id: 1, position: { x: 0, y: 0 }, name: "Player 1" },
                player2: { id: 2, position: { x: 4, y: 4 }, name: "Player 2" },
            },
            currentPlayer: 1,
        };
>>>>>>> 99905e67290b72179816e9ea3f5236fb22a031f7

        

        // Function to generate the grid
        function generateGrid() {
    const grid = document.getElementById('gameGrid').getElementsByTagName('tbody')[0];
    
    // Clear existing grid if necessary
    grid.innerHTML = '';

    for (let i = 0; i < 5; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 5; j++) {
            const cell = document.createElement('td');
            cell.id = `cell-${i}-${j}`;
            cell.onclick = () => fetchValidMove(i+1, j+1); // Click handler for each cell
            row.appendChild(cell);
        }
        grid.appendChild(row);
    }
}
async function fetchAndPaintBoard() {
    try {
        const response = await fetch("http://127.0.0.1:5000/gameboard");
        if (!response.ok) {
            throw new Error("Network response was not OK");
        }

        const data = await response.json();
        if (data.board) {
            const boardArray = data.board.split(' '); // Adjust based on how your board is structured
            const grid = document.getElementById('gameGrid').getElementsByTagName('tbody')[0];

            // Clear the existing board before painting
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    const cell = grid.querySelector(`#cell-${i}-${j}`);
                    const cellValue = boardArray[i][j];

                    // Set cell color based on the value
                    if (cellValue === '1') {
                        cell.style.backgroundColor = 'blue'; // Player 1
                        cell.innerText = 'J1';
                    } else if (cellValue === '2') {
                        cell.style.backgroundColor = 'red'; // Player 2
                        cell.innerText = 'J2';
                    } else {
                        cell.style.backgroundColor = 'white'; // Empty cell
                        cell.innerText = '';
                    }
                }
            }
        } else {
            console.error("No board data in response:", data);
        }
    } catch (error) {
        console.error("Error fetching board:", error);
    }
}

        // Function to start the game
        async function startGame() {
            try {
                const response = await fetch("http://127.0.0.1:5000/start_game", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error("Network response was not OK");
                }

                const data = await response.json();
                console.log("Game started:", data);

                if (data.status === "success") {
                    // Initialize game state with the server response
                    initializeGameState(data.gameState);
                } else {
                    console.error("Failed to start the game:", data);
                }
            } catch (error) {
                console.error("Error starting game:", error);
            }
        }

        // Function to initialize the game state based on the received data
        function initializeGameState(gameStateData) {
            // Update player positions and game state based on server data
            gameState.players.player1.position = gameStateData.posPlayer1;
            gameState.players.player2.position = gameStateData.posPlayer2;
            gameState.currentPlayer = gameStateData.currentPlayer;
            fetchAndPaintBoard()

            // Log the updated state
            console.log("Updated game state:", gameState);
        }

        // Ensure the board is generated before calling startGame
        window.onload = function() {
            generateGrid();  // Generate the grid first
            startGame();
            fetchAndPaintBoard()     // Then call startGame to initialize the game
        };

        // Function to fetch the game board (if needed)
        async function fetchBoard() {
            try {
                const response = await fetch("http://127.0.0.1:5000/gameboard");
                if (!response.ok) {
                    throw new Error("Network response was not OK");
                }

                const boardString = await response.text();  // Use .text() for non-JSON responses
                console.log("Board:", boardString);
                return boardString;
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }
        async function fetchValidMove(i, j) {
    try {
        const response = await fetch("http://127.0.0.1:5000/validate_move", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ i: i, j: j })
        });

        if (!response.ok) {
            throw new Error("Network response was not OK");
        }

        const data = await response.json();
        console.log("Valid move response:", data);
        fetchAndPaintBoard()
        return data;
    } catch (error) {
        console.error("Error fetching valid move:", error);
    }
}
    </script>
</body>
</html>
